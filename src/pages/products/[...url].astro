---
import Layout from '../../layouts/Layout.astro';
import ProductImages from "../../components/ProductImages";
import SmallDesc from "../../components/SmallDesc";
import CurrentlyViewingBanner from "../../components/CurrentlyViewingBanner";
import Bundle from "../../components/Bundle";
import AddToCart from "../../components/AddToCart";
import Dropdowns from "../../components/Dropdowns";
import AddToCartPopup from '../../components/AddToCartPopup';
import ReviewsPage from "../../components/ReviewsPage";
import { urlString } from '../../utils/api';

export async function getStaticPaths() {
  try {
    const response = await fetch(`${urlString}/products`);
    
    if (!response.ok) {
      console.error(`Error fetching products: ${response.statusText}`);
      return [];
    }

    const data = await response.json();
    
    // Normalize data
    let products = [];
    if (Array.isArray(data)) {
      products = data;
    } else if (data && Array.isArray(data.data)) {
      products = data.data;
    }

    const filteredProducts = products.filter((product) => !product.free);

    return filteredProducts.map((product) => ({
      params: { url: product.url },
      props: { 
        ...product,
        product: product
      }
    }));

  } catch (error) {
    console.error("Build Error in getStaticPaths:", error);
    return [];
  }
}

const { url } = Astro.params;
const props = Astro.props;

const product = props.product || {};
const { 
  name = "Product Not Found", 
  price = 0, 
  oldPrice = 0, 
  image = [], 
  desc = "", 
  metaDesc = "", 
  smallDesc = [],
  dropdowns = [], 
  reviews = [], 
  models = [] 
} = props;

const title = name;
const description = metaDesc;
---

<Layout title={title} description={description}>
  <section class="singlep-main">
    <div class="singlep-main-container">
      <ProductImages images={image} client:load/>
      <section class="singlep-main-info">
        <div class="titles">
          <a href="/products">Back to all products</a>
          <h1>{name}</h1>
        </div>
        <SmallDesc smallDescs={smallDesc} client:load />
        <div class="product-payment">
          <p class="currentlyviewing">
            <img
              src="/svg/eye.svg"
              width="14"
              height="auto"
              decoding="async"
              alt="Eye icon"
            />
            <CurrentlyViewingBanner checkout={false} client:only/>
          </p>
          <div class="product-bundle">
            <Bundle price={price} oldPrice={oldPrice} models={models} client:load/>
            <p>Free shipping included</p>
            <AddToCart product={product} small={false} client:only />
          </div>
        </div>
        <div class="dropdowns">
          <Dropdowns dropdowns={dropdowns} client:load />
        </div>
      </section>
    </div>
  </section>
  <AddToCartPopup product={product} client:only />
  <section class="singlep-desc">
    <div set:html={desc}></div>
  </section>
  <ReviewsPage url={url} reviews={reviews} client:load />
</Layout>

<script>
	import { initVisit } from '../../stores/visit';
	initVisit();
</script>